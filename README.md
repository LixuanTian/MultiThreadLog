# 多线程异步日志库

日志库大体分为**前段**和**后端**两部分。前段是供应用程序使用的接口（API），并生成日志的消息；后端则负责把日志消息写到目的地。

## 安装使用
Requires:  
  GCC >= 4.7  
  Boost (for boost::any only.)  
Install required packages:   
Ubuntu：  
  $ sudo apt install g++ cmake make libboost-dev  
To build, run:  
  $ mkdir build  
  $ cd build/  
  $ cmake ../  
  $ make

## 功能需求

在多线程中，难点在于将日志数据从多个前段高效的传输到后端（属于**多生产者-单消费者**问题）

对于生产者（前端），要尽量做到低延迟、低CPU开销，无阻塞

对于消费者（后端），要做到足够大的吞吐量，并占用较少的资源

## 前端输出

目前的日志库采用的是C++stream风格的输出方式

```
LOG_INFO << "Received" ....
```

日志输出的格式

|  日期  |     时间      |  线程  |   级别   |   正文   |      源文件名称      |        行号        |
| :----: | :-----------: | :----: | :------: | :------: | :------------------: | :----------------: |
| 年月日 | 时:分:秒.微妙 | 线程ID | 日志级别 | 正文部分 | 输出日志所在的源文件 | 输出日志所在的行号 |



## 多线程异步日志

在多线程异步日志中主要的流程是：用一个背景线程负责收集日志消息，并写入到日志文件，其他的业务线程只管往这个“日志线程”中发送日志消息，这称为“异步日志”

### 实现方式

常规的实现方式是使用一个“队列”来将前端的日志数据传送到后端（日志线程）。

### muduo实现方式

muduo日志库使用的是**双缓冲技术**，基本思路是准备两块buffer：A和B，前端负责往buffer  A填入数据（日志消息），后端负责将buffer B的数据写入到文件中。当buffer A写满之后，交换A和B，让后端将buffer A的数据写入文件，而前端则往buffer B填入新的日志消息，如此往复。

使用两个buffer的好处是在新建日志消息的时候不必等待磁盘文件操作，也避免每条日志消息都触发（唤醒）后端日志线程。也就是说，前端不是将一条条日志消息分别传送给后端，而是将多条日志消息拼接成一个大的buffer传送给后端，减少了线程的唤醒频率，降低了开销。

另外，为了及时将日志消息写入文件，即时buffer A未满，日志库也会每3秒执行一次上述交换写操作。

# 测试性能

日志库在机器上的实测性能数据

|           |                   DT01ACA2                   |
| --------- | :------------------------------------------: |
| nop       | 消息/s：537.2万/s             MiB/s : 563.02 |
| /dev/null | 消息/s：487.5万/s             MiB/s : 510.89 |
| /tmp/log  | 消息/s：423.2万/s             MiB/s : 443.47 |

多线程下在机器上的实测性能数据

| 线程数量 | 写入的总数据量/MB | 花费的时间/s |
| :------: | :---------------: | :----------: |
|    10    |      11.5MB       |    0.023     |
|    20    |      23.0MB       |    0.045     |
|    30    |      34.5MB       |    0.072     |
|    40    |      46.0MB       |    0.093     |
|    50    |      57.4MB       |    0.118     |
|    60    |      68.9MB       |    0.183     |
|    70    |      80.4MB       |    0.297     |
|    80    |      91.9MB       |    0.331     |
|    90    |      103.4MB      |    0.403     |
|   100    |      114.9MB      |    0.420     |

# 参考链接
http://github.com/chenshuo/muduo

